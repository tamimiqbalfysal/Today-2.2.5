
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is the owner of a document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // USERNAMES: Ensure usernames are unique and can be claimed on signup.
    match /usernames/{username} {
      allow read;
      allow create: if request.auth != null;
      allow delete: if isOwner(resource.data.uid);
    }
    
    // USERS: Basic profile data.
    match /users/{userId} {
      allow read; 
      allow create: if isOwner(userId);
      
      // Allow users to update their own profile information
      allow update: if isOwner(userId);

      // Allow authenticated users to update other users' 'following' and 'followers' lists
      allow update: if request.auth != null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['followers', 'following', 'unreadNotifications']);

      allow delete: if isOwner(userId);

      // NOTIFICATIONS: Subcollection for user-specific notifications.
      match /notifications/{notificationId} {
        allow read, write, delete: if isOwner(userId);
      }
    }

    // POSTS: User-generated content.
    match /posts/{postId} {
      allow read;
      allow create, update: if isOwner(request.resource.data.authorId);
      allow delete: if isOwner(resource.data.authorId);
    }

    // GIFT CODES: For the "Thank u, G!" feature.
    match /giftCodes/{codeId} {
        allow read;
        // Allow any authenticated user to claim a code (update isUsed to true).
        allow update: if request.auth != null && request.resource.data.isUsed == true && resource.data.isUsed == false;
        // Only allow admins (or backend processes with elevated privileges) to create new codes.
        allow create: if false; // Recommended: use Admin SDK for creation.
    }
    
    // THINK CODES: For the pop-up dialog.
    match /thinkCodes/{codeId} {
      allow read;
      allow update: if request.auth != null && request.resource.data.isUsed == true && resource.data.isUsed == false;
      allow create: if false; // Recommended: use Admin SDK for creation.
    }
  }
}
